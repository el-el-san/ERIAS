# ERIAS

ERIASは、Discord AIエージェントとして機能するプロジェクトです。プロジェクト開発のプランニング、コーディング、テスト、デバッグを自律的に行う統合開発支援エージェントです。

## 主要機能

ERIASは以下の主要なエージェントで構成され、開発ワークフローを支援します。

- **Planner**: ユーザーの要求に基づき、開発計画を立案します。プロジェクト構造、必要なファイル、依存関係などを分析し、実装戦略を決定します。
- **Coder**: 計画に基づきコードを生成し、依存関係の管理やフィードバックによるコード修正を行います。README.mdの生成も担当します。
- **Tester**: 生成されたコードのテストを実行し、結果を報告します。テスト実行環境の構築や自動テストの実行、結果の解析を行います。
- **Debugger**: テストや実行中に発生したエラーを診断し、修正を試みます。エラーの根本原因分析とコード修正案の提示を行います。
- **GitHubTaskExecutor**: GitHub リポジトリとの連携（ファイルの取得、プッシュ、プルリクエスト作成など）を行います。既存リポジトリへの機能追加や修正作業を自動化します。
- **FeedbackHandler**: ユーザーからのフィードバックを受け付け、開発計画やコードに反映させるプロセスを管理します。開発中のプロジェクトに対して追加の指示や修正要求を反映します。

## 技術スタック

ERIASは以下の技術スタックを使用しています：

- **Node.js**: ランタイム環境
- **TypeScript**: 型安全なコーディングのために使用
- **Discord.js**: Discordとの連携インターフェース
- **Google Gemini API**: AI言語モデルとの連携（コード生成、計画作成）
- **Octokit**: GitHub APIとの連携
- **Simple Git**: Gitリポジトリの操作
- **Jest**: テストフレームワーク
- **Winston**: ロギングライブラリ

## 実装詳細

### コア構造

- **AgentCore**: 全体のオーケストレーションを担当するクラス。各エージェント（Planner, Coder, Tester, Debugger）を初期化し、タスクの生成から完了までの一連のプロセスを管理します。
- **ProjectGenerator**: 実際のプロジェクト生成プロセスを実行するクラス。各フェーズ（計画、コーディング、テスト、デバッグ）を順番に実行し、ユーザーフィードバックを適切なタイミングで処理します。

### LLM統合

- **GeminiClient**: Google Gemini APIと通信し、AI言語モデルを利用したテキスト生成を行うクラス。
- **PromptBuilder**: 各フェーズに適したプロンプトを構築するクラス。コンテキスト、現在の状態、ユーザーフィードバックを考慮したプロンプトを生成します。
- **ConversationManager**: 会話履歴を管理し、コンテキストを維持するクラス。

### Discord連携

- **DiscordBot**: Discordとの連携インターフェースを提供するクラス。メッセージの受信、コマンドの処理、進捗通知などを担当します。
- **CommandHandler**: Discordコマンドの処理を担当するクラス。
- **FeedbackMessageHandler**: ユーザーからのフィードバックメッセージを処理するクラス。

### GitHub連携機能

ERIASは既存のGitHubリポジトリへの機能追加や修正をサポートしており、以下の機能を提供します：

- **リポジトリのクローン**: 指定されたGitHubリポジトリを自動的にクローンします。
- **ブランチ操作**: 新しい作業ブランチを作成し、変更を分離管理します。
- **コード分析**: リポジトリのコード構造を分析し、適切な変更点を特定します。
- **コード生成**: 指示に基づいて新しいコードを生成または既存コードを修正します。
- **変更のコミットとプッシュ**: 変更内容をコミットし、リモートリポジトリにプッシュします。
- **プルリクエスト作成**: 変更内容をレビューするためのプルリクエストを自動作成します。

## GitHub連携機能の修正

GitHubリポジトリへの変更のプッシュとプルリクエストの作成機能において、プルリクエスト作成時に「No commits between...」エラーが発生する問題を修正しました。

この修正により、新しいフィーチャーブランチを作成する前に、ローカルリポジトリのデフォルトブランチ（例: `main`）をリモートリポジトリの最新の状態に同期する処理が追加されました。これにより、プルリクエスト作成時にベースブランチとの間に適切な差分が認識されるようになります。

### 修正内容

- `src/services/githubService.ts`: ローカルブランチをリモートと同期する `syncBranch` メソッドを追加しました。このメソッドは指定したブランチをチェックアウトし、リモートから最新の変更をプルして同期します。
- `src/agent/githubTaskExecutor.ts`: 新しいブランチを作成する前に、`githubService.syncBranch` を呼び出す処理を追加しました。これにより、最新の状態からブランチが作成されるようになります。

## フィードバック機能

ERIASは開発中のプロジェクトに対して、リアルタイムでユーザーからのフィードバックを受け付け、反映することができます：

- **フィードバックキュー**: ユーザーからのフィードバックをキューに格納し、適切なタイミングで処理します。
- **優先度と緊急度**: フィードバックには優先度（normal/high）と緊急度（normal/critical）を設定でき、重要なフィードバックを優先的に処理できます。
- **コンテキスト適応**: 開発フェーズに応じてフィードバックの処理方法を変更します（計画フェーズ、コーディングフェーズなど）。
- **ファイル指定**: 特定のファイルに対するフィードバックを指定できます。

---

## 【2025/04 修正履歴】

### TypeScript型・実装の同期とビルドエラー修正

- `src/agent/types.ts`の型定義（`CoderInterface`, `UserFeedback`, `DevelopmentPlan`, `FileInfo`）と実装の不一致を修正しました。
- `Coder`クラスに`regenerateFile`, `adjustFileWithFeedback`, `addFeatureFromFeedback`の必須メソッドを追加し、`regenerateFile`は`fixCode`のロジックを移植しました。
- `UserFeedback`型のプロパティ参照（`filePath`→`targetFile`、`feedback`→`content`など）を修正しました。
- `DevelopmentPlan`型に存在しない`buildCommand`プロパティの参照を削除しました。
- `PromptBuilder`に`buildFixPrompt`メソッドと`PromptType.FIX`を追加し、コード修正プロンプト生成に対応しました。
- `generateReadme`メソッドを`Coder`クラスに追加し、プロジェクトのREADME.md自動生成に対応しました。
- クラス外に出ていたメソッド定義や重複を整理し、TypeScript構文エラーを解消しました。

---

## 使用方法

1. `.env.example`をコピーして`.env`ファイルを作成し、必要な環境変数を設定します：
   - `DISCORD_TOKEN`: DiscordボットのAPIトークン
   - `GEMINI_API_KEY`: Google Gemini APIキー
   - `GITHUB_TOKEN`: GitHub APIトークン（GitHubリポジトリ操作に必要）
   
2. 依存関係をインストールします：
   ```
   npm install
   ```

3. アプリケーションをビルドします：
   ```
   npm run build
   ```

4. アプリケーションを起動します：
   ```
   npm start
   ```

## Discordコマンド

- `/new [仕様]`: 新しいプロジェクトを生成します
- `/status [タスクID]`: プロジェクト生成の状態を確認します
- `/cancel [タスクID]`: 実行中のプロジェクト生成をキャンセルします
- `/clear`: 現在の会話履歴をクリアします
- `/help`: ヘルプを表示します

## フィードバック指示

実行中のプロジェクトにフィードバックを提供するには：
```
task:タスクID [内容]
```

タグオプション：
- `#urgent` または `#緊急`: 緊急の指示として処理
- `#feature` または `#機能`: 新機能の追加として処理
- `#fix` または `#修正`: バグ修正指示として処理
- `#code` または `#コード`: コード修正指示として処理
- `file:パス`: 特定ファイルに対する指示（例: `file:src/App.js`）

## ライセンス

MIT
